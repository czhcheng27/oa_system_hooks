!(function () {
  "use strict";
  tinymce.PluginManager.add("kityformula-editor", function (editor, url) {
    var baseURL =
      tinymce.baseURL + "/plugins/kityformula-editor/kityFormula.html";

    editor.on("dblclick", function () {
      var sel = editor.selection.getContent();
      // 更通用的匹配方式，识别任意 <img> 含 data-latex 的标签
      var match = sel.match(/<img[^>]+data-latex="([^"]+)"[^>]*>/);
      if (match) {
        var param = encodeURIComponent(match[1]);
        openDialog(param);
      }
    });

    var openDialog = function (param) {
      return editor.windowManager.openUrl({
        title: "Insert Formula",
        size: "large",
        width: 785,
        height: 475,
        url: param ? baseURL + "?c=" + param : baseURL,
        buttons: [
          {
            type: "cancel",
            text: "Close",
          },
          {
            type: "custom",
            text: "Save",
            name: "save",
            primary: true,
          },
        ],
        onAction: function (api, details) {
          if (details.name === "save") {
            api.sendMessage("save");
          }
        },
      });
    };

    editor.ui.registry.addButton("kityformula-editor", {
      text: "Insert Formula",
      tooltip: "Insert Formula",
      icon: "formula",
      onAction: function () {
        openDialog();
      },
    });

    editor.ui.registry.addMenuItem("kityformula-editor", {
      text: "Insert Formula",
      onAction: function () {
        openDialog();
      },
    });

    return {
      getMetadata: function () {
        return {
          name: "Insert Formula",
          url: "http://hgcserver.gitee.io",
        };
      },
    };
  });
})();
